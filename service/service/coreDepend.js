const config = require('../config/apiconfig');

let api = new config.InfinitoApi(config.apiConfig);
let wallet = new config.EthWallet(config.walletConfig);
wallet.setApi(api);
let coinAPI = api.ETH;

const contractAdd = '0xc4d329240dde1231740b94c9b675177fbf4aa51a';
const abi =
[
	{
		"constant": false,
		"inputs": [
			{
				"name": "_user",
				"type": "string"
			},
			{
				"name": "_symbol",
				"type": "string"
			},
			{
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "addBounty",
		"outputs": [
			{
				"name": "",
				"type": "bool"
			}
		],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_user",
				"type": "string"
			},
			{
				"name": "_symbol",
				"type": "string"
			},
			{
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "subBounty",
		"outputs": [
			{
				"name": "",
				"type": "bool"
			}
		],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_user",
				"type": "string"
			},
			{
				"name": "_symbol",
				"type": "string"
			}
		],
		"name": "getAllBounty",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_user",
				"type": "string"
			},
			{
				"name": "_symbol",
				"type": "string"
			}
		],
		"name": "getPresentBounty",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_user",
				"type": "string"
			}
		],
		"name": "getSizesymbols",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_symbol",
				"type": "string"
			}
		],
		"name": "getSizeusers",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_user",
				"type": "string"
			},
			{
				"name": "i",
				"type": "uint256"
			}
		],
		"name": "getSymbol",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_symbol",
				"type": "string"
			},
			{
				"name": "i",
				"type": "uint256"
			}
		],
		"name": "getUser",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
];

const data = '0x608060405234801561001057600080fd5b50611338806100206000396000f30060806040526004361061008e576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806301f66d0e1461009357806332e2e16b1461015757806358dd35391461021a5780636d58cd62146102975780637bdcd86b1461038357806386eeb86114610446578063b8e1640e14610532578063c0d268a6146105f6575b600080fd5b61013d600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050610673565b604051808215151515815260200191505060405180910390f35b34801561016357600080fd5b50610204600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610a7a565b6040518082815260200191505060405180910390f35b34801561022657600080fd5b50610281600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610b5b565b6040518082815260200191505060405180910390f35b3480156102a357600080fd5b50610308600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050610bd3565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561034857808201518184015260208101905061032d565b50505050905090810190601f1680156103755780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561038f57600080fd5b50610430600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610d84565b6040518082815260200191505060405180910390f35b34801561045257600080fd5b506104b7600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050610e65565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156104f75780820151818401526020810190506104dc565b50505050905090810190601f1680156105245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6105dc600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050611017565b604051808215151515815260200191505060405180910390f35b34801561060257600080fd5b5061065d600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506111ef565b6040518082815260200191505060405180910390f35b6000806000856040518082805190602001908083835b6020831015156106ae5780518252602082019150602081019050602083039250610689565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020846040518082805190602001908083835b60208310151561071757805182526020820191506020810190506020830392506106f2565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000015414156108a5576001846040518082805190602001908083835b60208310151561078c5780518252602082019150602081019050602083039250610767565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208390806001815401808255809150509060018203906000526020600020016000909192909190915090805190602001906107fa929190611267565b50506002836040518082805190602001908083835b602083101515610834578051825260208201915060208101905060208303925061080f565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208490806001815401808255809150509060018203906000526020600020016000909192909190915090805190602001906108a2929190611267565b50505b816000856040518082805190602001908083835b6020831015156108de57805182526020820191506020810190506020830392506108b9565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020846040518082805190602001908083835b6020831015156109475780518252602082019150602081019050602083039250610922565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160008282540192505081905550816000856040518082805190602001908083835b6020831015156109c3578051825260208201915060208101905060208303925061099e565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020846040518082805190602001908083835b602083101515610a2c5780518252602082019150602081019050602083039250610a07565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160008282540192505081905550600190509392505050565b600080836040518082805190602001908083835b602083101515610ab35780518252602082019150602081019050602083039250610a8e565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020826040518082805190602001908083835b602083101515610b1c5780518252602082019150602081019050602083039250610af7565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010154905092915050565b60006002826040518082805190602001908083835b602083101515610b955780518252602082019150602081019050602083039250610b70565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805490509050919050565b606060008210158015610c565750600180846040518082805190602001908083835b602083101515610c1a5780518252602082019150602081019050602083039250610bf5565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080549050038211155b1515610c6157600080fd5b6001836040518082805190602001908083835b602083101515610c995780518252602082019150602081019050602083039250610c74565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902082815481101515610cd957fe5b906000526020600020018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d775780601f10610d4c57610100808354040283529160200191610d77565b820191906000526020600020905b815481529060010190602001808311610d5a57829003601f168201915b5050505050905092915050565b600080836040518082805190602001908083835b602083101515610dbd5780518252602082019150602081019050602083039250610d98565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020826040518082805190602001908083835b602083101515610e265780518252602082019150602081019050602083039250610e01565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000154905092915050565b606060008210158015610ee9575060016002846040518082805190602001908083835b602083101515610ead5780518252602082019150602081019050602083039250610e88565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080549050038211155b1515610ef457600080fd5b6002836040518082805190602001908083835b602083101515610f2c5780518252602082019150602081019050602083039250610f07565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902082815481101515610f6c57fe5b906000526020600020018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561100a5780601f10610fdf5761010080835404028352916020019161100a565b820191906000526020600020905b815481529060010190602001808311610fed57829003601f168201915b5050505050905092915050565b6000816000856040518082805190602001908083835b602083101515611052578051825260208201915060208101905060208303925061102d565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020846040518082805190602001908083835b6020831015156110bb5780518252602082019150602081019050602083039250611096565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010154101515156110ff57600080fd5b816000856040518082805190602001908083835b6020831015156111385780518252602082019150602081019050602083039250611113565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020846040518082805190602001908083835b6020831015156111a1578051825260208201915060208101905060208303925061117c565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160008282540392505081905550600190509392505050565b60006001826040518082805190602001908083835b6020831015156112295780518252602082019150602081019050602083039250611204565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805490509050919050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106112a857805160ff19168380011785556112d6565b828001600101855582156112d6579182015b828111156112d55782518255916020019190600101906112ba565b5b5090506112e391906112e7565b5090565b61130991905b808211156113055760008160009055506001016112ed565b5090565b905600a165627a7a723058209b00617d3c185baf937e57e3466eac9c8c47d062db7eb9f270dff25ecd5c5f2b0029';
const bounty = new config.web3.eth.Contract(abi, contractAdd);
bounty.options.from = '0x03c33d697509f0eb46844063e27bf079cb973bdd';
bounty.options.gas = 4700000;
bounty.options.data = data;

function addDepend(_gid, _lid)
{
	return new Promise(function(resolve, reject)
	{
		function checktransaction(data)
		{
			coinAPI.getTxInfo(data.tx_id).then(function(transactions){
				if (transactions.cd == "1")
				{
					return resolve(false);
				}
				else if (transactions.data.transactions.length == 0)
				{
					return checktransaction(data);
				}
				else
				{
					return resolve(true);
				}
			});
		}
		let txParams = {};
		txParams.sc = {}; 
		txParams.sc.contractAddress = contractAdd;
		txParams.sc.nameFunc = 'addDepend';
		txParams.sc.typeParams = ['string', 'string'];
		txParams.sc.paramsFuncs = [_gid, _lid];
		wallet.createRawTx(txParams).then(function(rawTx){
			return wallet.send({
				rawTx: rawTx,
				isBroadCast: true
			});
		}).then(function(data){
			return checktransaction(data);	
		});
	});
}

function getDepend(_gid, _lid)
{
	return new Promise(function(resolve, reject){
		bounty.methods.getDepend(_gid, _lid).call().then(function(data){
			return resolve(data);
		});
	});
}


function getSizeLevel(_gid)
{
	return new Promise(function(resolve, reject){
		bounty.methods.getSizeLevel(_gid).call().then(function(data){
			return resolve(data);
		});
	});
}

function getSizeGift(_lid)
{
	return new Promise(function(resolve, reject){
		bounty.methods.getSizeGift(_lid).call().then(function(data){
			return resolve(data);
		});
	});
}

function getIdLevel(_gid, _i)
{
	return new Promise(function(resolve, reject){
		bounty.methods.getIdLevel(_gid, _i).call().then(function(data){
			return resolve(data);
		});
	});
}

function getIdGift(_lid, _i)
{
	return new Promise(function(resolve, reject){
		bounty.methods.getIdGift(_lid, _i).call().then(function(data){
			return resolve(data);
		});
	});
}

function getAllLevel(_gid)
{
	return new Promise(function(resolve, reject) {
		var arr = [];
		var end = false;
		function getIdLevel(i)
		{
			if (i>=0)
			{
				bounty.methods.getIdLevel(_gid, i).call().then(function(re){
					arr.push(re);
					getIdLevel(i-1);
				});
			}
			else
			{
				end = true;
				return resolve(arr);
			}
		}
		bounty.methods.getSizeLevel(_gid).call().then(function(re){
			getUser(re-1);
		});
	});
}

function getAllGift(_lid)
{
	return new Promise(function(resolve, reject) {
		var arr = [];
		var end = false;
		function getIdGift(i)
		{
			if (i>=0)
			{
				bounty.methods.getIdGift(_lid, i).call().then(function(re){
					arr.push(re);
					getIdGift(i-1);
				});
			}
			else
			{
				end = true;
				return resolve(arr);
			}
		}
		bounty.methods.getSizeGift(_lid).call().then(function(re){
			getSymbol(re-1);
		});
	});
}


// addDepend("123", "456").then(console.log);
// getDepend("123", "456").then(console.log);
// getSizeLevel("123").then(console.log);
// getSizeGift("456").then(console.log);
// getIdLevel("123", 0).then(console.log);
// getIdGift("456", 0).then(console.log);
// getAllGift("456").then(console.log);
// getAllLevel("123").then(console.log);

module.exports =
{
	addDepend: addDepend,
	getDepend: getDepend,
	getSizeLevel: getSizeLevel,
	getSizeGift: getSizeGift,
	getIdLevel: getIdLevel,
	getIdGift: getIdGift,
	getAllLevel: getAllLevel,
	getAllGift: getAllGift
}